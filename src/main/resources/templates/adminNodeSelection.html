<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Taeum</title>


<link
	href="https://getbootstrap.com/docs/5.3/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
	crossorigin="anonymous">
<script
	src="https://getbootstrap.com/docs/5.3/dist/js/bootstrap.bundle.min.js"
	integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
	crossorigin="anonymous"></script>
<link
	href="https://getbootstrap.com/docs/5.3/examples/sidebars/sidebars.css"
	rel="stylesheet">
<script type="text/javascript"
	src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9c49835d1348562532a0d8a13f2f7bf3"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bxslider/4.2.15/jquery.bxslider.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bxslider/4.2.15/jquery.bxslider.min.js"></script>
	
	<title>노드 할당</title>
	<link rel="stylesheet" href="css/style.css">

	 <th:block th:insert="~{fragments :: header}" />


	

	</head>
	<body>

<main class="d-flex flex-nowrap">
	<div
		class="d-flex flex-column align-items-stretch flex-shrink-0 bg-body-tertiary border border-r-1"
		style="width: 380px;">
		<div
			class="d-flex align-items-center flex-shrink-0 p-3 link-body-emphasis text-decoration-none">
			<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
				fill="#4ae39c" viewBox="0 0 256 256" class="me-2">
       <path
					d="M232,128A104,104,0,1,1,128,24,104.13,104.13,0,0,1,232,128Z" fill="#3F7EFC"></path>
     </svg>
			<span class="fs-5 fw-semibold">경로 최적화 결과</span>
		</div>
		<div
			class="d-flex flex-wrap py-3 px-2 gap-3 align-items-center justify-content-center border-bottom">
			<div class="d-flex flex-column align-items-center">
				<div id="totalVisit">0곳</div>
				<div class="fw-light" style="font-size: .75rem">경유지</div>
			</div>
			<div class="border-start border-2 h-50"></div>
			<div class="d-flex flex-column align-items-center">
				<div id="totalDistance">0km</div>
				<div class="fw-light" style="font-size: .75rem">이동거리</div>
			</div>
			<div class="border-start border-2 h-50"></div>
			<div class="d-flex flex-column align-items-center">
				<div id="totalDuration">0분</div>
			
				<div class="fw-light" style="font-size: .75rem">이동시간</div>
			</div>
		</div>

		<div class="list-group scrollarea px-3 flex-grow-1" id="nodeList">
		<div>
		<span class = "fs-5 fw-semibold" > 할당 지역 :</span>
		  <span type="text" class="fs-5 fw-semibold"  th:text="${dr_AREA}"></span>
		</div>
			<div th:each="node, count : ${nodeList}" class="abc">
			
				<th:block th:if="${node.kind == 1 and node.dR_ID == 0}">
				

					<a href="#" id="bechaList"
						class="list-group-item list-group-item-action py-3 lh-sm mt-3 border rounded-2">
						<div
							class="d-flex w-100 align-items-center justify-content-start mb-1">
							<span class="badge text-bg-secondary"> <th:block
									th:if="${node.kind == 1}">출발</th:block>

							</span> <strong class="ms-1" th:text="${node.address}"></strong> <span
								type="text" id="onOff">off</span> <input type="hidden"
								th:value="${node.node_id}" id="node_id">
								
								<div>
								  <span type="text"th:text="${node.cycle}"></span>
								</div>
						</div>
						<div class="mt-3 small">
							<div class="d-flex align-items-center justify-content-between">
								<div class="d-flex align-items-center">
									<span
										class="badge text-bg-light border border-secondary-subtle me-2">m_id</span>
									<span class="node_mid" th:text="${node.m_ID}"></span>
								</div>
								<div class="d-flex align-items-center">
									<span
										class="badge text-bg-light border border-secondary-subtle me-2">node.node_id</span>
									<span th:text="${node.node_id}" id="bechaList"></span> <span
										type="hidden" class="ride" th:text="${node.kind}"></span>
								</div>
								<div class="d-flex align-items-center"></div>

							</div>

						</div>
					</a>
				</th:block>
				</th:block>
				
			</div>
		</div>


		<div class="d-flex align-items-center justify-content-center p-3">
			<button type="button" class="btn btn-dark w-100" onclick="goVrp()" style="background-color: #3F7EFC;">경로 최적화</button>
		</div>
	</div>



	<div id="map" class="w-100"></div>

	<form id="deliveryForm" action="updateDelivery" method="post">
		<button type="button" class="btn btn-success"
			style="position: fixed; top: 15px; right: 20px; z-index: 1030; background-color: #3F7EFC;"
			onclick="send()" >전송</button>

			
			
			 <select class="btn btn-success"
      style="position: fixed; top: 15px; right: 100px; z-index: 1030;  background-color: #3F7EFC;"
      id="cycle">
      <option value="1">1차 배정</option>
      <option value="2">2차 배정</option>
      <option value="3">3차 배정</option>
    </select> 
    
		<input type="hidden" name="filed_m_id" value="" class="btn btn-success"
			style="position: fixed; top: px; right: 300px; z-index: 1030;">
    
  
	</form>

	<div
		class="w-100 h-100 fixed-top justify-content-center align-items-center bg-opacity-10 bg-success"
		id="spin" style="display: none;">
		<div class="spinner-border" role="status">
			<span class="visually-hidden">Loading...</span>
		</div>
	</div>

  


</main>
<script th:inline="javascript">
var mapContainer = document.getElementById('map'), // 지도를 표시할 div
mapOption = {
   center: new kakao.maps.LatLng(37.4845117, 126.694807), // 지도의 중심좌표(인천일보아카데미)
   level: 8 // 지도의 확대 레벨
};
var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다


function spinOn() {
     $("#spin").addClass("d-flex");
   }
   function spinOff() {
     $("#spin").removeClass("d-flex");
   }
  

// 각 링크에 클릭 이벤트를 추가합니다.
   var links = document.querySelectorAll('.list-group-item-action');
   links.forEach(function(link) {
       link.addEventListener('click', function() {
           
           toggleOnOff(link);
       });
   });

   function send() {
       // 선택한 m_id들을 서버로 전송하는 로직을 추가하세요.
       // 여기서는 폼을 서버로 전송하는 것으로 대체합니다.
     var deliveryForm = document.getElementById("deliveryForm");
    var filedMIdInput = document.getElementsByName("filed_m_id")[0]; // 인풋 태그를 가져옵니다.
    var mIdValue = filedMIdInput.value; // m_id 값을 가져옵니다.
    var cycle = document.getElementById('cycle').value;
    var selectedDriver = [[${drID}]];
    var currentTime = new Date(); // 현재 시간을 가져옵니다.
 // 현재 페이지 URL 가져오기
    const currentUrl = window.location.href;

    // URL에서 파라미터 부분만 추출
    const queryString = currentUrl.split('?')[1];

    // 추출한 파라미터를 &로 나누어 배열로 변환
    const queryParamsArray = queryString.split('&');

    // 파라미터를 담을 객체 생성
    const queryParams = {};

    // 각 파라미터를 key-value 쌍으로 분리하여 객체에 추가
    queryParamsArray.forEach(param => {
        const [key, value] = param.split('=');
        queryParams[key] = decodeURIComponent(value); // URL 디코딩
    });
 // selectDate 파라미터 값에서 # 제거
    const selectDateWithoutHash = queryParams.selectDate.replace('#', '');
    console.log(selectDateWithoutHash);
    // selectDate 파라미터 값 출력

    
 // 년도, 월, 일
    var year = currentTime.getFullYear();
    var month = ('0' + (currentTime.getMonth() + 1)).slice(-2); // 월은 0부터 시작하므로 +1 필요
    var day = ('0' + currentTime.getDate()).slice(-2);

    // 시간, 분, 초
    var hours = ('0' + currentTime.getHours()).slice(-2);
    var minutes = ('0' + currentTime.getMinutes()).slice(-2);
    var seconds = ('0' + currentTime.getSeconds()).slice(-2);

    // 형식 지정
    var formattedTime = year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds;
    
    
    $.ajax({
        url: deliveryForm.action,
        method: deliveryForm.method,
        data: {
            ride: selectedDriver, // ride 파라미터에 적절한 값을 입력하세요.
            node_id: mIdValue,
            cycle : cycle,
            dateTime : formattedTime,
            selectedTime : selectDateWithoutHash
        },
        success: function(response) {
            // 요청이 성공적으로 처리된 경우 실행할 코드를 작성하세요.
            alert( "배차 선정 완료\n 현재시각: " + formattedTime);
            alert(selectedTime);
            window.location.href = "adminDriverList";
        },
        error: function(xhr, status, error) {
            // 요청이 실패한 경우 실행할 코드를 작성하세요.\
        	alert("에러");
        }
    });
}
   
   
   // onOff 요소를 토글하는 함수
   function toggleOnOff(link) {
	   var nodeId = link.querySelector('#node_id').value; // 클릭된 요소 내의 숨겨진 입력 필드에서 노드의 ID를 가져옵니다.
       var nodeMId = link.querySelector('.node_mid').textContent.trim(); // 클릭된 요소 내의 'm_id'를 가져옵니다.
       var node = findNodeById(nodeId); // 해당하는 노드를 찾습니다.
       var onOffElement = link.querySelector('#onOff'); // 클릭된 요소 내에서 on/off 요소를 찾습니다.
       if (nodeMId && node.kind === 1) {
       if (onOffElement.textContent.trim() === 'off') {
           onOffElement.textContent = 'on';
           addMarker(node);
           addConnectedMarker(nodeMId, nodeId);
           /* selectedMIds.push(nodeId); // 배열에 선택한 m_id를 추가합니다.
           updateMIdInput(selectedMIds.join(', ')); */
           // 배열에 있는 m_id들을 인풋 태그에 업데이트합니다.
           }else {
               onOffElement.textContent = 'off';
               removeConnectedMarker(nodeMId, nodeId);
               removeMarker(node);
                var index = selectedMIds.indexOf(nodeId);
               if (index !== -1) {
                   selectedMIds.splice(index, 1); // 배열에서 해당 m_id를 제거합니다.
                   updateMIdInput(selectedMIds.join(', '));
                   // 배열에 있는 m_id들을 인풋 태그에 업데이트합니다.
               } 
           }
       } 
   }

   var selectedMIds = []; // 선택한 m_id들을 저장할 배열
   
// m_id를 인풋 태그에 업데이트하는 함수
   function updateMIdInput(mId) {
       var filedMIdInput = document.getElementsByName("filed_m_id")[0]; // 인풋 태그를 가져옵니다.
       filedMIdInput.value = mId; // m_id 값을 업데이트합니다.
   }
   
   
   // 마커를 토글하는 함수
   function toggleMarker(node) {
	  
       var marker = markers[node.node_id]; // 해당 노드에 대한 마커를 가져옵니다.
       if (marker) {
           // 이미 마커가 추가되었으면 삭제합니다.
           marker.setMap(null);
           delete markers[node.node_id]; // 마커를 markers 객체에서 제거합니다.
           delete NODE_MAP[node.node_id];
       } else {
           // 마커가 추가되지 않았으면 추가합니다.
           addMarker(node);
           NODE_MAP[node.node_id] = node;
       }
   }
   
   var nodeList = /*[[${nodeList}]]*/ null;
   console.log("nodeList = ", nodeList);

   function findNodeById(nodeId) {
       for (const node of nodeList) {
    	
           if (parseInt(node.node_id) === parseInt(nodeId)) {
        	  
               return node; // 해당하는 ID를 가진 노드를 찾으면 반환합니다.
           }
       }
       return null; // 해당하는 ID를 가진 노드가 없으면 null을 반환합니다.
   }
   
   // 해당하는 노드의 마커를 추가하는 함수
   function addMarker(node) {
       var markerPosition = new kakao.maps.LatLng(node.y, node.x); // 해당하는 노드의 위치
       var marker = new kakao.maps.Marker({
           position: markerPosition
       });
       marker.setMap(map); // 마커를 지도에 추가합니다.
       markers[node.node_id] = marker; // 마커를 markers 객체에 저장합니다.
       NODE_MAP[node.node_id] = node;
   }
   // 해당하는 노드의 마커를 제거하는 함수
   function removeMarker(node) {
	  
       var marker = markers[node.node_id]; // 해당 노드에 대한 마커를 가져옵니다.
       console.log("node =" + node);
       console.log("node.node_id =" + node.node_id);
       if (marker) {
           // 마커가 추가되었으면 삭제합니다.
           console.log("통과")
           marker.setMap(null);
           delete markers[node.node_id]; // 마커를 markers 객체에서 제거합니다.
           delete NODE_MAP[node.node_id];
           
       }
   }
// 클릭된 항목의 'm_id'와 같은 kind가 2인 노드의 마커를 추가하는 함수
   function addConnectedMarker(nodeMId, nodeId) {
 
	   selectedMIds.push(nodeId); // 배열에 선택한 m_id를 추가합니다.
       updateMIdInput(selectedMIds.join(', ')); 
          
       // nodeList에서 'm_id'가 nodeMId인 노드들을 찾습니다.
       const connectedNodes = nodeList.filter(node => parseInt(node.m_ID) === parseInt(nodeMId) && parseInt(node.kind) === 2);
       // 찾은 노드들의 마커를 추가합니다.
       connectedNodes.forEach(node => {
           console.log("add 통과 = " + node);
           addMarker(node); 
           NODE_MAP[node.node_id] = node;
           selectedMIds.push(node.node_id); // 배열에 선택한 m_id를 추가합니다.
           updateMIdInput(selectedMIds.join(', ')); 
       });
   }
   
   function addConnectedNodeId(nodeMId) {}
   
// 클릭된 항목의 'm_id'와 같은 kind가 2인 노드의 마커를 제거하는 함수
   function removeConnectedMarker(nodeMId, nodeId) {
       // nodeList에서 'm_id'가 nodeMId이고 kind가 2인 노드들을 찾습니다.
       const connectedNodes = nodeList.filter(node => parseInt(node.m_ID) === parseInt(nodeMId)  && parseInt(node.kind) === 2);
       const id = connectedNodes.map(node => node.node_id); // 선택된 노드들의 id 배열
       // 찾은 노드들의 마커를 제거합니다.
       id.forEach(nodeId => {
           const node = findNodeById(nodeId); // 노드 ID로 노드를 가져옵니다.
           if (node) {
               removeMarker(node); // 해당 노드의 마커를 제거합니다.
           }
       });

       // 선택된 노드들의 ID를 selectedMIds 배열에서 제거합니다.
       id.forEach(nodeId => {
           const index = selectedMIds.indexOf(nodeId);
           console.log("index = " + index);
           if (index !== -1) {
               selectedMIds.splice(index, 1);
           }
       });

       // 인풋 태그에 선택된 m_id들을 업데이트합니다.
       updateMIdInput(selectedMIds.join(', '));
   }

  
   // 각 노드에 대한 마커를 저장하기 위한 객체
   var markers = {};
   
   
// 주변 약국 검색
function searchPoi() {
  // 지도의 중심좌표를 얻어옵니다
  var latlng = map.getCenter();
  const x = latlng.getLng();
  const y = latlng.getLat();

 
  spinOn();
  $.ajax({
    url: '/poi',
    data: {
      x: x,
      y: y
    },
    <!-- 여기서 result는 그냥 변수 -->
    success: function (result) { 
      if (result.code != 'SUCC') {
        alert("주변 약국 검색에 실패 하였습니다.");
        spinOff();
        return;
      }
      const data = result.data;
      spinOff();
      displayData(data);
      
    },
    error: function () {
        spinOff();
      alert("주변 약국 검색에 실패 하였습니다.");
    }
  });
}


//ajax 응답 받은 데이터로 화면에 그리기.
const NODE_MAP = {};
const MARKER_MAP = {};
const INFO_MAP = {};
function displayData(data) {
  
  
  const totalDistance = data.totalDistance;// 전체이동거리(미터)
  const totalDuration = data.totalDuration;// 전체이동시간(초)
  const totalPathPointList = data.totalPathPointList;// // 전체이동경로
  const nodeList = data.nodeList;// // 방문지목록
  const dr_AREA = [[${dr_AREA}]];
  $("#totalVisit").text(nodeList.length + "곳");
  $("#totalDistance").text((totalDistance / 1000).toFixed(2) + "km");
  $("#totalDuration").text(secondsToHoursMinutes(totalDuration));
 
  let html = '';
  let count = 0;
  var bounds = new kakao.maps.LatLngBounds(); 
  for(const node of nodeList) {
    // 왼쪽에 보이는 목록 
    NODE_MAP[node.node_id] = node;  
    html += ` <!-- 백팁은 일반 html을 쓸수 있듯이 자바스크립트에서 쓸 수 있게 만들어 줌. -->
    
      <a href="javascript:panTo(${node.node_id});" class="list-group-item list-group-item-action py-3 lh-sm mt-3 border rounded-2">
        <div class="d-flex w-100 align-items-center justify-content-start mb-1">
          <span class="badge text-bg-secondary">${++count}</span><strong class="ms-1">${node.address}</strong>
          <input type="hidden" value="${node.node_id}" id="node_id">
        </div>
        <div class="mt-3 small">
        <div class="d-flex align-items-center justify-content-between">
         <div class="d-flex align-items-center"><span class="badge text-bg-light border border-secondary-subtle me-2">m_id</span> <span id="node.m_ID">${node.m_id}</span></div>
          <div class="d-flex align-items-center"><span class="badge text-bg-light border border-secondary-subtle me-2">출발 / 도착</span> 
          <div th:if="${node.kind == 1}">
          <span> 출발지</span>
          </div>
          <div th:unless="${node.kind == 1}">
          <span> 도착지</span>
          </div> 
          </div>
          <div class="d-flex align-items-center"><span class="badge text-bg-light border border-secondary-subtle me-2">배정 기사</span> <span>${node.dR_ID}</span></div>
            </div>
          </div>
        </div>
      </a>
    `;
    
    //노드 하나당 마커를 찍음.
    drawMarker(node, bounds);
  }
  // 경로를 그리기.
  drawPath(totalPathPointList);
 
  //전체의 마커가 잘 보이두록 자동 이동.
  if(nodeList.length > 0) {
    map.setBounds(bounds);
  }
  $("#nodeList").html(html);
  spinOff();
}



$(document).ready(function() {
    // 페이지 로딩 시 탑승 여부 표시
    $('.ride').each(function() {
        var rideValue = $(this).text().trim(); // 각각의 ride 요소에 있는 텍스트 가져오기
        if (rideValue === '1') {
            $(this).text("탑승완료");
        } else if (rideValue === 'null') {
            $(this).text("탑승여부");
        }
    });
});


function rideButton(button){
	console.log("click성공");
	 // 버튼의 부모 요소에서 탑승 여부를 찾아서 변경합니다.
    $(button).parent().find('#ride').html("탑승완료");
	 
	 var ride = 1
	   var node_id = $(button).closest('.list-group-item').find('#node_id').val();
	 console.log("node_id = " + node_id);
	 
	   spinOn();
	 
	 $.ajax({
	        url: '/ride',
	        data: {
	          ride : ride,
	          id : node_id
	        },

	        success: function (result) { 
	          if (result.code != 'SUCC') {
	        	
	            return;
	          }
	          const data = result.data;
	          
	          displayData(data);
	  
	          
	        },
	        error: function () {
	           
	          alert("탑승성공 실패.....................");
	        }
	      });
	 

}
function secondsToHoursMinutes(seconds) {
     // 시간으로 변환
     const hours = Math.floor(seconds / 3600);
     // 남은 분 계산
     const minutes = Math.floor((seconds % 3600) / 60);
     // 시간과 분을 "00" 형식으로 변환. 시간이 0일 경우, 시간 표시 생략
     const formattedHours = hours > 0 ? `${hours.toString().padStart(2, '0')}시간 ` : '';
     const formattedMinutes = minutes.toString().padStart(2, '0');
     return `${formattedHours}${formattedMinutes}분`;
   }
   
   
   
    function drawMarker(node, bounds) {
     const position = new kakao.maps.LatLng(node.y, node.x);
     bounds.extend(position);
     // 배열의 좌표들이 잘 보이게 마커를 지도에 추가합니다
     const marker = new kakao.maps.Marker({position: position, clickable: true});
     marker.setMap(map);
     const name = node.name;
     const phone = node.phone;
     // 인포윈도우를 생성합니다
     const infowindow = new kakao.maps.InfoWindow({
       content: '<div style="padding:5px;">' + name + '<br/>' + phone + '</div>',
       removable: true
     });
    
     MARKER_MAP[node.node_id] = marker; //바깥에서 인식이 가능하도록 전역변수 설정
     INFO_MAP[node.node_id] = infowindow; 
     
     // 마커에 클릭이벤트를 등록합니다
     kakao.maps.event.addListener(marker, 'click', function () {
       infowindow.open(map, marker);
     });
   }



    var POLYLINE = null;
    function drawPath(pathPointList) {
      if(pathPointList.length > 0) {
        // 선을 구성하는 좌표 배열입니다. 이 좌표들을 이어서 선을 표시합니다
        var linePath = [];
        for(var point of pathPointList) {
          linePath.push(new kakao.maps.LatLng(point.y, point.x));
        }
       
        // 지도에 표시할 선을 생성합니다
        POLYLINE = new kakao.maps.Polyline({
            path: linePath, // 선을 구성하는 좌표배열 입니다
            strokeWeight: 5, // 선의 두께 입니다
            strokeColor: 'red', // 선의 색깔입니다
            strokeOpacity: 0.7, // 선의 불투명도 입니다 1에서 0 사이의 값이며 0에 가까울수록 투명합니다
            strokeStyle: 'solid' // 선의 스타일입니다
        });
        // 지도에 선을 표시합니다
        POLYLINE.setMap(map);
      }
    }

    //지도의 중심을 이동싴미는 기능
    function panTo(nodeId) {
       clearInfoWindow();
       const node = NODE_MAP[nodeId];
       INFO_MAP[nodeId].open(map, MARKER_MAP[nodeId]);
       // 이동할 위도 경도 위치를 생성합니다
       var moveLatLon = new kakao.maps.LatLng(node.y, node.x);
       // 지도 중심을 부드럽게 이동시킵니다
       // 만약 이동할 거리가 지도 화면보다 크면 부드러운 효과 없이 이동합니다
       map.panTo(moveLatLon);
     }

     function clearInfoWindow() {
       for(const nodeId in INFO_MAP) {
         INFO_MAP[nodeId].close();
       }
     }

   



     
     function goVrp() {
        
       spinOn();
          $.ajax({
              url: '/vrp',
              type: 'post', // 관련정보들이 주소창에 나올 이유는 없으니 post로 돌림.
              contentType: "application/json", //data(body)에 json 을 담으려면 둘이 셑트임(data,contenType)
              data: 
            	  JSON.stringify(Object.values(NODE_MAP)), // 컨트롤러에서 받은 data값이 JOSN 형식으로 Ajox 돌림.
              success: function (result) { // 에러코드 200일땐 성공
                  if (result.code != 'SUCC') {
                      alert("경로 최적화에 실패 하였습니다.");
                      spinOff();
                      return;
                  }
                  const data = result.data;
                  displayData(data);
              },
              error: function () { // 에러코드가 200이 아닌 경우.
                  spinOff();
                  alert("경로 최적화에 실패 하였습니다.");
              }
          });
          
  
      }
     
 

</script>

</body>
</html>